<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Three.js Classic Viewer — IBL + Tools</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root { --nav-h: 56px; }
    body { margin: 0; }
    #overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.65);
      color: #fff; display: flex; align-items: center; justify-content: center;
      font-size: 1rem; z-index: 10;
    }
    .sidebar { max-width: 420px; }
    .viewer-wrap { height: calc(100vh - var(--nav-h)); }
    #viewer canvas { display:block; width:100%; height:100%; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark" style="height:var(--nav-h)">
    <div class="container-fluid">
      <span class="navbar-brand">Three.js Classic</span>
      <a class="btn btn-outline-light btn-sm" href="about.html">About</a>
    </div>
  </nav>

  <div id="overlay">Loading…</div>

  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3 p-3 bg-light sidebar">
        <h5 class="mb-3">Controls</h5>

        <!-- Model Selector -->
        <div class="mb-3">
          <label for="modelSelect" class="form-label">Select Model</label>
          <select id="modelSelect" class="form-select">
            <option value="models/DamagedHelmet/DamagedHelmet.gltf">Damaged Helmet</option>
            <option value="models/CesiumMan/CesiumMan.glb">Cesium Man</option>
            <option value="models/WaterBottle/WaterBottle.glb">Water Bottle</option>
            <option value="models/Duck/Duck.glb">Duck</option>
          </select>
        </div>

        <!-- Environment Map (HDR) -->
        <div class="mb-3">
          <label for="envSelect" class="form-label">Environment Map (HDR)</label>
          <select id="envSelect" class="form-select">
            <option value="hdr/studio_small_08_1k.hdr">Studio Small 08</option>
            <option value="hdr/venice_sunset_1k.hdr">Venice Sunset</option>
          </select>
        </div>

        <!-- Lighting Preset Selector -->
        <div class="mb-3">
          <label for="lightSelect" class="form-label">Lighting Preset</label>
          <select id="lightSelect" class="form-select">
            <option value="studio">Studio</option>
            <option value="outdoor">Outdoor</option>
            <option value="dramatic">Dramatic</option>
          </select>
        </div>

        <!-- Playback & Camera -->
        <div class="mb-3 d-grid gap-2">
          <div class="btn-group">
            <button id="btnPlay" class="btn btn-success btn-sm">Play</button>
            <button id="btnPause" class="btn btn-warning btn-sm">Pause</button>
            <button id="btnWire" class="btn btn-secondary btn-sm">Wireframe</button>
          </div>
          <div class="btn-group">
            <button id="btnCam1" class="btn btn-primary btn-sm">Camera 1</button>
            <button id="btnCam2" class="btn btn-primary btn-sm">Camera 2</button>
            <button id="btnReset" class="btn btn-danger btn-sm">Reset Camera</button>
          </div>
          <div class="btn-group">
            <button id="btnScreenshot" class="btn btn-outline-dark btn-sm">Download PNG</button>
          </div>
        </div>

        <!-- Selection & Material Tools -->
        <div class="mb-3">
          <h6>Selection</h6>
          <div class="small text-muted mb-2">Click a part of the model to select it.</div>
          <div class="mb-2"><strong>Selected:</strong> <span id="selectedName">None</span></div>

          <label class="form-label">Base Color</label>
          <input id="matColor" type="color" class="form-control form-control-color" value="#6c8cff">

          <label class="form-label mt-2">Roughness</label>
          <input id="matRough" type="range" min="0" max="1" step="0.01" value="0.5" class="form-range">

          <label class="form-label mt-2">Metalness</label>
          <input id="matMetal" type="range" min="0" max="1" step="0.01" value="0.2" class="form-range">

          <button id="btnClearSel" class="btn btn-outline-secondary btn-sm mt-2">Clear Selection</button>
        </div>

        <!-- Animation Controls -->
        <div class="mb-3">
          <h6>Animations</h6>
          <select id="animSelect" class="form-select mb-2" disabled></select>
          <div class="btn-group">
            <button id="btnAnimPlay" class="btn btn-outline-success btn-sm" disabled>Play</button>
            <button id="btnAnimPause" class="btn btn-outline-warning btn-sm" disabled>Pause</button>
            <button id="btnAnimStop" class="btn btn-outline-danger btn-sm" disabled>Stop</button>
          </div>
        </div>
      </div>

      <div class="col-md-9 p-0">
        <div id="viewer" class="viewer-wrap"></div>
      </div>
    </div>
  </div>

  <!-- Three.js classic build + loaders (stable, r0.124.0) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/examples/js/loaders/RGBELoader.js"></script>

  <script>
    let scene, camera, renderer, controls, model;
    let hemi, dir, spot;
    let isPlaying = true;

    // Picking & materials
    let raycaster, pointer, selected = null, lastMaterial = null;

    // Animations
    let mixer = null, clock = new THREE.Clock(), actions = {};

    const overlay = document.getElementById('overlay');
    function setOverlay(text){ overlay.textContent = text || ''; overlay.style.display = text ? 'flex' : 'none'; }

    function init() {
      const viewer = document.getElementById('viewer');

      // Scene & Camera
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x111111);

      const rect = viewer.getBoundingClientRect();
      camera = new THREE.PerspectiveCamera(60, rect.width / rect.height, 0.1, 100);
      camera.position.set(2.5, 2, 3);
      scene.add(camera);

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
      renderer.setSize(rect.width, rect.height);
      // Recommended output/tone mapping for HDR IBL
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;
      renderer.outputEncoding = THREE.sRGBEncoding;
      viewer.appendChild(renderer.domElement);

      // Controls
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Picking
      raycaster = new THREE.Raycaster();
      pointer = new THREE.Vector2();
      renderer.domElement.addEventListener('pointerdown', onPointerDown);

      // Default lighting + environment
      setLightingPreset('studio');
      setEnvironment(document.getElementById('envSelect').value);

      // Initial model (local with remote fallback)
      loadModel(
        'models/DamagedHelmet/DamagedHelmet.gltf',
        'Damaged Helmet',
        'https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf'
      );

      window.addEventListener('resize', onResize);
    }

    function onResize() {
      const viewer = document.getElementById('viewer');
      const rect = viewer.getBoundingClientRect();
      renderer.setSize(rect.width, rect.height);
      camera.aspect = rect.width / rect.height;
      camera.updateProjectionMatrix();
    }

    // -------- Environment (HDR IBL) --------
    function setEnvironment(hdrUrl) {
      const rgbeLoader = new THREE.RGBELoader();
      rgbeLoader.setDataType(THREE.UnsignedByteType);
      setOverlay('Loading Environment…');
      rgbeLoader.load(hdrUrl, (texture) => {
        texture.mapping = THREE.EquirectangularReflectionMapping;
        scene.environment = texture;    // for PBR reflections
        scene.background = texture;     // show the HDR as background
        setOverlay('');
      }, undefined, (err) => {
        console.error('Error loading HDRI:', err);
        setOverlay('Failed to load environment');
      });
    }

    // -------- Lighting Presets --------
    function setLightingPreset(preset) {
      [hemi, dir, spot].forEach(l => { if (l) scene.remove(l); });
      hemi = dir = spot = null;

      if (preset === 'studio') {
        hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
        scene.add(hemi);
        dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(3, 5, 2); scene.add(dir);
      } else if (preset === 'outdoor') {
        hemi = new THREE.HemisphereLight(0xcce0ff, 0x444444, 1.2);
        scene.add(hemi);
        dir = new THREE.DirectionalLight(0xffffff, 1.0);
        dir.position.set(-5, 10, -5); scene.add(dir);
      } else if (preset === 'dramatic') {
        spot = new THREE.SpotLight(0xffffff, 1.5);
        spot.position.set(5, 5, 5);
        spot.angle = Math.PI / 6;
        scene.add(spot);
      }
    }

    // -------- Selection / Materials --------
    function setSelected(mesh) {
      if (selected && lastMaterial) selected.material = lastMaterial;
      selected = null; lastMaterial = null;

      const nameSpan = document.getElementById('selectedName');
      nameSpan.textContent = 'None';

      if (!mesh) return;

      lastMaterial = mesh.material;
      mesh.material = lastMaterial.clone();
      selected = mesh;
      nameSpan.textContent = mesh.name || mesh.parent?.name || mesh.uuid;

      if (mesh.material.color) {
        document.getElementById('matColor').value = '#' + mesh.material.color.getHexString().padStart(6, '0');
      }
      if ('roughness' in mesh.material) document.getElementById('matRough').value = mesh.material.roughness;
      if ('metalness' in mesh.material) document.getElementById('matMetal').value = mesh.material.metalness;
    }

    function onPointerDown(event) {
      const rect = renderer.domElement.getBoundingClientRect();
      pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

      raycaster.setFromCamera(pointer, camera);
      if (!model) return;

      const meshes = [];
      model.traverse((c) => { if (c.isMesh) meshes.push(c); });
      const hits = raycaster.intersectObjects(meshes, true);
      setSelected(hits.length ? hits[0].object : null);
    }

    // -------- Model Loading + Animations --------
    function loadModel(url, label, fallbackUrl) {
      const loader = new THREE.GLTFLoader();
      setOverlay(`Loading ${label}…`);

      loader.load(
        url,
        (gltf) => {
          if (model) scene.remove(model);
          if (mixer) { mixer.stopAllAction(); mixer = null; actions = {}; }
          setSelected(null);

          model = gltf.scene;
          scene.add(model);
          setOverlay('');

          // Animations
          const animSelect = document.getElementById('animSelect');
          const playBtn = document.getElementById('btnAnimPlay');
          const pauseBtn = document.getElementById('btnAnimPause');
          const stopBtn = document.getElementById('btnAnimStop');

          animSelect.innerHTML = '';
          animSelect.disabled = playBtn.disabled = pauseBtn.disabled = stopBtn.disabled = true;

          if (gltf.animations && gltf.animations.length) {
            mixer = new THREE.AnimationMixer(model);
            actions = {};
            gltf.animations.forEach((clip, i) => {
              const name = clip.name || `Clip${i}`;
              actions[name] = mixer.clipAction(clip);
              const opt = document.createElement('option');
              opt.value = name; opt.textContent = name;
              animSelect.appendChild(opt);
            });
            animSelect.disabled = playBtn.disabled = pauseBtn.disabled = stopBtn.disabled = false;
            animSelect.selectedIndex = 0;
          }
        },
        (xhr) => {
          const pct = xhr.total ? Math.round((xhr.loaded / xhr.total) * 100) : 0;
          setOverlay(`Loading ${label}… ${pct}%`);
        },
        (err) => {
          console.error(`Error loading ${label}:`, err);
          if (fallbackUrl) {
            setOverlay(`Local failed — loading remote ${label}…`);
            loadModel(fallbackUrl, `${label} (remote)`);
          } else {
            setOverlay(`Failed to load ${label}.`);
          }
        }
      );
    }

    function animate() {
      requestAnimationFrame(animate);

      const delta = clock.getDelta();
      if (mixer) mixer.update(delta);
      if (isPlaying && model) model.rotation.y += 0.005;

      controls.update();
      renderer.render(scene, camera);
    }

    // -------- Event bindings --------
    document.addEventListener('DOMContentLoaded', () => {
      init();
      animate();

      // Model select
      document.getElementById('modelSelect').addEventListener('change', (e) => {
        const url = e.target.value;
        const label = e.target.options[e.target.selectedIndex].text;
        const fallback = url.includes('DamagedHelmet')
          ? 'https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf'
          : null;
        loadModel(url, label, fallback);
        camera.position.set(2.5, 2, 3);
        controls.target.set(0,0,0);
        controls.update();
      });

      // Lighting preset select
      document.getElementById('lightSelect').addEventListener('change', (e) => {
        setLightingPreset(e.target.value);
      });

      // Environment map select
      document.getElementById('envSelect').addEventListener('change', (e) => {
        setEnvironment(e.target.value);
      });

      // Playback & wireframe
      document.getElementById('btnPlay').addEventListener('click', () => { isPlaying = true; });
      document.getElementById('btnPause').addEventListener('click', () => { isPlaying = false; });
      document.getElementById('btnWire').addEventListener('click', () => {
        if (!model) return;
        model.traverse((child) => { if (child.isMesh) child.material.wireframe = !child.material.wireframe; });
      });

      // Camera presets
      document.getElementById('btnCam1').addEventListener('click', () => {
        camera.position.set(2.5, 2.0, 3.0); controls.target.set(0,0,0); controls.update();
      });
      document.getElementById('btnCam2').addEventListener('click', () => {
        camera.position.set(-1.5, 1.2, 2.5); controls.target.set(0,0.2,0); controls.update();
      });
      document.getElementById('btnReset').addEventListener('click', () => {
        camera.position.set(2.5, 2, 3); controls.target.set(0,0,0); controls.update();
      });

      // Material editor
      document.getElementById('matColor').addEventListener('input', (e) => {
        if (selected && selected.material.color) selected.material.color.set(e.target.value);
      });
      document.getElementById('matRough').addEventListener('input', (e) => {
        if (selected && 'roughness' in selected.material) selected.material.roughness = parseFloat(e.target.value);
      });
      document.getElementById('matMetal').addEventListener('input', (e) => {
        if (selected && 'metalness' in selected.material) selected.material.metalness = parseFloat(e.target.value);
      });
      document.getElementById('btnClearSel').addEventListener('click', () => setSelected(null));

      // Animation controls
      const animSelect = document.getElementById('animSelect');
      document.getElementById('btnAnimPlay').addEventListener('click', () => {
        if (!mixer || !animSelect.value) return;
        Object.values(actions).forEach(a => a.stop());
        actions[animSelect.value].reset().play();
      });
      document.getElementById('btnAnimPause').addEventListener('click', () => {
        if (!mixer) return;
        Object.values(actions).forEach(a => a.paused = true);
      });
      document.getElementById('btnAnimStop').addEventListener('click', () => {
        if (!mixer) return;
        Object.values(actions).forEach(a => a.stop());
      });
      document.getElementById('btnScreenshot').addEventListener('click', () => {
        // Force a render so we capture the latest frame
        renderer.render(scene, camera);

        const a = document.createElement('a');
        const niceName = (document.getElementById('modelSelect')
                    ?.selectedOptions?.[0]?.text || 'model').replace(/\s+/g, '_');
        const ts = new Date().toISOString().replace(/[:.]/g, '-');
        a.href = renderer.domElement.toDataURL('image/png');
        a.download = `screenshot_${niceName}_${ts}.png`;
        a.click();
      });

    });
  </script>
</body>
</html>
